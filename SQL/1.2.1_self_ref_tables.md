# Self-Referencing Table

## üß© What Is a Self-Referencing Table?

A **self-referencing table** is a table that has a **foreign key** pointing **back to its own primary key**.

‚úÖ This allows you to represent **hierarchical** or **tree-like** relationships *within a single table*.

---

## üíº Example 1: Employee Hierarchy

Let‚Äôs imagine an organization where every employee might have a **manager**, who is also an **employee**.

### üîπ Table: `employees`

| employee_id | name        | manager_id |
| ----------- | ----------- | ---------- |
| 1           | Alice Smith | NULL       |
| 2           | Bob Johnson | 1          |
| 3           | Carol White | 1          |
| 4           | Dan Brown   | 2          |

### Explanation:

* `Alice Smith` (ID 1) ‚Üí **no manager** (`manager_id = NULL`)
* `Bob Johnson` (ID 2) ‚Üí managed by **Alice** (`manager_id = 1`)
* `Carol White` (ID 3) ‚Üí managed by **Alice** (`manager_id = 1`)
* `Dan Brown` (ID 4) ‚Üí managed by **Bob** (`manager_id = 2`)

### üíæ SQL Definition

```sql
CREATE TABLE employees (
  employee_id INT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  manager_id INT,
  FOREIGN KEY (manager_id) REFERENCES employees(employee_id)
);
```

Here:

* `employee_id` = **primary key**
* `manager_id` = **foreign key** referencing **the same table**

---

### üîç Query Example: List Employees with Their Managers

```sql
SELECT 
  e.name AS employee,
  m.name AS manager
FROM employees e
LEFT JOIN employees m
  ON e.manager_id = m.employee_id;
```

**Result:**

| employee    | manager     |
| ----------- | ----------- |
| Alice Smith | NULL        |
| Bob Johnson | Alice Smith |
| Carol White | Alice Smith |
| Dan Brown   | Bob Johnson |

üß† This is called a **self-join** ‚Äî the table joins to itself using aliases (`e` and `m`).

---

## üóÇ Example 2: Categories and Subcategories

You can also use a self-referencing table for nested categories ‚Äî such as product categories in an online store.

| category_id | category_name | parent_id |
| ----------- | ------------- | --------- |
| 1           | Electronics   | NULL      |
| 2           | Computers     | 1         |
| 3           | Laptops       | 2         |
| 4           | Desktops      | 2         |
| 5           | Phones        | 1         |

### SQL Definition:

```sql
CREATE TABLE categories (
  category_id INT PRIMARY KEY,
  category_name VARCHAR(100),
  parent_id INT,
  FOREIGN KEY (parent_id) REFERENCES categories(category_id)
);
```

This creates a **hierarchical tree**:

```
Electronics
 ‚îú‚îÄ‚îÄ Computers
 ‚îÇ    ‚îú‚îÄ‚îÄ Laptops
 ‚îÇ    ‚îî‚îÄ‚îÄ Desktops
 ‚îî‚îÄ‚îÄ Phones
```

---

### üîç Query Example: Get Subcategories with Their Parent

```sql
SELECT 
  c.category_name AS subcategory,
  p.category_name AS parent_category
FROM categories c
LEFT JOIN categories p
  ON c.parent_id = p.category_id;
```

**Result:**

| subcategory | parent_category |
| ----------- | --------------- |
| Computers   | Electronics     |
| Laptops     | Computers       |
| Desktops    | Computers       |
| Phones      | Electronics     |

---

## ‚öôÔ∏è Why Use Self-Referencing Tables?

| Benefit                     | Description                                                                    |
| --------------------------- | ------------------------------------------------------------------------------ |
| üß± **Simplicity**           | Keeps hierarchy in one table instead of creating multiple related ones.        |
| üå≥ **Supports hierarchies** | Ideal for managers, categories, org charts, folders, menus, etc.               |
| üîó **Flexible queries**     | Easily find parent, child, or full hierarchy using joins or recursive queries. |

---

## üöÄ Advanced: Recursive Query (CTE)

Modern MySQL (v8+) supports **Common Table Expressions (CTEs)**, which make it easy to query hierarchical data.

**Example:** Get all employees under Alice (recursively)

```sql
WITH RECURSIVE employee_hierarchy AS (
  SELECT employee_id, name, manager_id
  FROM employees
  WHERE name = 'Alice Smith'
  
  UNION ALL
  
  SELECT e.employee_id, e.name, e.manager_id
  FROM employees e
  INNER JOIN employee_hierarchy eh
  ON e.manager_id = eh.employee_id
)
SELECT * FROM employee_hierarchy;
```

üí° This recursive CTE will return Alice, Bob, Carol, and Dan ‚Äî showing the full hierarchy under Alice.

---

## üß† Summary Table

| Term                   | Description                                          | Example                                                        |
| ---------------------- | ---------------------------------------------------- | -------------------------------------------------------------- |
| Self-referencing table | Table that references itself through a foreign key   | `employees(manager_id ‚Üí employee_id)`                          |
| Self-join              | Joining a table to itself using aliases              | `employees e JOIN employees m ON e.manager_id = m.employee_id` |
| Use cases              | Hierarchies, trees, relationships within same entity | Employees, Categories, Menus, Folders                          |
| Recursive query        | SQL feature for multi-level hierarchies              | `WITH RECURSIVE ...`                                           |

---